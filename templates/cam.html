<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR and Barcode Scanner</title>
    <script src="https://cdn.socket.io/3.1.3/socket.io.js"></script>
    <script src="https://cdn.rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga"></script>
</head>
<body>
    <h1>QR and Barcode Scanner</h1>

    <video id="scanner-video" width="300" height="200" autoplay></video>
    <div id="result"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var socket = io.connect('http://' + document.domain + ':' + location.port);

            socket.on('connect', function() {
                console.log('Connected to server');
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from server');
            });

            function startScanning() {
                // Get access to the camera
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        var video = document.getElementById('scanner-video');
                        video.srcObject = stream;

                        // Initialize the QR code scanner
                        var qrScanner = new Instascan.Scanner({ video: video });
                        qrScanner.addListener('scan', function(content) {
                            console.log('Scanned QR Code:', content);
                            socket.emit('qr_scanned', { data: content });
                            // Open the scanned URL in a new tab
                            window.open(content, '_blank');
                        });

                        // Start QR code scanner
                        Instascan.Camera.getCameras().then(function(cameras) {
                            if (cameras.length > 0) {
                                qrScanner.start(cameras[0]);
                            } else {
                                console.error('No cameras found.');
                            }
                        });

                        // Initialize the barcode scanner
                        Quagga.init({
                            inputStream: {
                                name: "Live",
                                type: "LiveStream",
                                target: video
                            },
                            decoder: {
                                readers: ["code_128_reader", "ean_reader", "upc_reader"]
                            }
                        }, function(err) {
                            if (err) {
                                console.error('Error initializing Quagga:', err);
                                return;
                            }
                            Quagga.start();
                        });

                        // Barcode detection
                        Quagga.onDetected(function(result) {
                            var code = result.codeResult.code;
                            console.log('Scanned Barcode:', code);
                            socket.emit('barcode_scanned', { data: code });
                            // Display the scanned barcode content
                            document.getElementById('result').innerText = 'Scanned Barcode: ' + code;
                        });
                    })
                    .catch(function(error) {
                        console.error('Error accessing camera:', error);
                    });
            }

            startScanning();
        });
    </script>
</body>
</html>
